<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>gear.js</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
</head>
<style type="text/css">
	* {
		margin: 0;
		padding: 0;
	}
</style>
<body>
<script type="text/javascript" src="lib/gear.js"></script>
<script type="text/javascript" src="lib/config.js"></script>
<script type="text/javascript" src="lib/input.js"></script>
<script type="text/javascript" src="lib/events.js"></script>
<script type="text/javascript" src="lib/loader.js"></script>
<script type="text/javascript" src="lib/states.js"></script>
<script type="text/javascript" src="lib/utils.js"></script>
<script type="text/javascript" src="lib/draw.js"></script>
<script type="text/javascript" src="lib/vector.js"></script>
<script type="text/javascript" src="lib/easing.js"></script>
<script type="text/javascript" src="lib/tween.js"></script>
<script type="text/javascript" src="levels.js"></script>
<script type="text/javascript" src="language.js"></script>
<script type="text/javascript">

        var gear = new GEAR();

        gear.viewport = new Vector(480, 800);
        gear.resizable = true;
        gear.center = true;
        gear.init();

        var lang = "en";

        gear.input.enableKeyboard();
        gear.input.enableTouch(gear.canvas);
        // gear.input.enableMouse(gear.canvas);

        function contain(p, c) {
            var x1 = p.x,
                    y1 = p.y;
            return (x1 - c.x) * (x1 - c.x) +
                         (y1 - c.y) * (y1 - c.y) < c.r * c.r;
        }
        function containRect(p, r) {
            return p.x > r.x &&
                         p.x < r.x + r.width &&
                         p.y > r.y &&
                         p.y < r.y + r.height;
        }

        var Menu = {
            playBtn: null,
            levels: [],
            levelsSave: null,
            move: false,
            offY: 0,
            startGame: false,
            mainMenu: true,
            startOff: -gear.viewport.y,
            startOff2: gear.viewport.y,
            capture: false,
            preload: function() {
                gear.load.image("locked", "res/img/locked2.png");
                gear.load.image("opened", "res/img/opened2.png");
                gear.load.image("down", "res/img/down-arrow.png");
                gear.load.font("font", "res/fonts/font3.otf");
                gear.load.audio("click", "res/audio/click.mp3");
                this.entity = function(x, y, r) {
                    this.x = x;
                    this.y = y;
                    this.cx = x;
                    this.cy = y;
                    this.r = r;
                    this.render = function() {
                        gear.draw.color = "rgb(36, 47, 63)";
                        gear.draw.circle(this.x, this.y, this.r);
                        gear.draw.color = "#f7f7f7";
                        gear.draw.circle(this.x, this.y, this.r - 3);
                    }
                };
                var c = false;
                for (var y = 0; y < 10; y++) {
                    for (var x = 0; x < 3; x++) {
                        if ((y * 3 + x) % 3 == 0)
                            c = !c;
                        this.levels.push({
                            index: y * 3 + x,
                            x: c ? 90 + x * 150 : gear.viewport.x - 90 - x * 150,
                            y: gear.viewport.y - 120 - y * 135, // 80
                            cy: gear.viewport.y - 120 - y * 135, // 80
                            offX: 0,
                            offY: 0,
                            r: 45,
                            opened: false
                        });
                    }
                }
            },
            init: function() {
                // this.mainMenu = true;
                // this.startGame = false;
                var saves = window.localStorage.getItem("mirror");
                if (!saves) {
                    this.levels[0].done = true;
                    window.localStorage.setItem("mirror", JSON.stringify({ levels: { 0: { done: true, tries: 0 } }, lang: "en" }));
                    
                    this.levels[0].opened = true;
                    
                    return;
                }
                this.levelsSave = JSON.parse(saves).levels;
                lang = JSON.parse(saves).lang || "en";
                if (!this.levelsSave) {
                    this.levelsSave = { 0: { done: true, tries: 0 } };
                    window.localStorage.setItem("mirror", JSON.stringify({ levels: this.levelsSave, lang: lang }));
                }
                for (var key in this.levelsSave) {
                    this.levels[key].opened = this.levelsSave[key].done;
                }

                // for (var i = 0; i < 30; i++) {
                //  this.levels[i].opened = true;
                // }
                // this.levels[1].opened = true;
                // this.levels[2].opened = true;
                // this.levels[3].opened = true;
            },
            moveBlocks: function(n, c) {
                var dy = (c ? this.levels[n].cy : 80) - this.levels[n].y;
                if (Math.abs(dy) > 0.05) {
                    var vy = dy * 0.09;
                    for (var i = 0; i < this.levels.length; i++) {
                        var l = this.levels[i];
                        l.y += vy;
                    }
                }
            },
            prevPressed: false,
            update: function() {
                if (gear.input.isPressed && !this.prevPressed) {
                    gear.audios['click'].currentTime = 0;
                    gear.audios['click'].play();
                }

                if (this.mainMenu) {

                    if (this.startGame) {
                        var vy = (0 - this.startOff) * 0.045;
                        this.startOff += vy;

                        if (Math.abs(this.startOff) < 0.5)
                            this.mainMenu = false;
                    }

                    if (gear.input.isPressed && !this.prevPressed) {
                        // 169.58251190185547 1195 140.83497619628906 80
                        // play
                        if (containRect(gear.input, {x: 169, y: 1195 + this.startOff, width: 141, height: 80})) {
                            this.startGame = true;
                        }
                        //170.4175033569336 1490 59.16499328613281 50
                        // en
                        if (containRect(gear.input, {x: 170, y: 1490 + this.startOff, width: 59, height: 50})) {
                            window.localStorage.setItem("mirror", JSON.stringify({ levels: this.levelsSave, lang: "en" }));
                            lang = "en";
                        }
                        //254.07500457763672 1490 51.84999084472656 50
                        // ru
                        if (containRect(gear.input, {x: 254, y: 1490 + this.startOff, width: 59, height: 50})) {
                            window.localStorage.setItem("mirror", JSON.stringify({ levels: this.levelsSave, lang: "ru" }));
                            lang = "ru";
                        }
                    }

                    this.prevPressed = gear.input.isPressed;
                    return;
                } else {
                    if (!this.startGame) {
                        var vy = (-gear.viewport.y - this.startOff) * 0.045;
                        this.startOff += vy;

                        this.moveBlocks(0, true);
                        if (Math.abs(-gear.viewport.y - this.startOff) < 0.5) {
                            this.mainMenu = true;
                        }
                    }
                }

                if (gear.input.isPressed && !this.prevPressed) {
                    //gear.ctx.drawImage(gear.images['down'], 220, gear.viewport.y - 55, 40, 40);
                    if (containRect(gear.input, { x: 220, y: this.levels[0].y + 65, width: 40, height: 40 })) {
                        this.startGame = false;
                    }
                }

                if (gear.input.isPressed) {
                        if (!this.capture) {
                            this.offY = gear.input.y;
                            for (var i = 0; i < this.levels.length; i++) {
                                var l = this.levels[i];
                                l.offY = l.y - gear.input.y;
                            }
                            this.capture = true;
                        } else {
                            if (Math.abs(this.offY - gear.input.y) > 30 && !this.move) {
                                this.move = true;
                            }
                        }
                        if (this.move)  {
                            for (var i = 0; i < this.levels.length; i++) {
                                var l = this.levels[i];
                                l.y = gear.input.y + l.offY;
                            }
                        }
                } else {
                    if (!this.move && this.prevPressed) {
                        for (var i = 0; i < this.levels.length; i++) {
                            var l = this.levels[i];
                            if (contain(gear.input, l) && l.opened) {
                                console.log(l.index);
                                gear.state.start("test", { levelNumber: l.index, levelsSave: this.levelsSave });
                            }
                        }
                    }

                    this.move = false;
                    this.capture = false;
                    if (this.levels.length > 0) {
                        var dy = this.levels[0].cy - this.levels[0].y;
                        if (dy > 0) {
                            this.moveBlocks(0, true);
                        } else if (dy < 0) {
                            if (this.levels.length > 15) {
                                var n = this.levels.length - 1;
                                dy = 80 - this.levels[n].y;
                                if (dy < 0)
                                    this.moveBlocks(n, false);
                            }
                        }
                    }
                }

                this.prevPressed = gear.input.isPressed;
            },
            render: function() {
                gear.draw.clear("#f7f7f7"); //fef6f3
                gear.ctx.save();
                gear.ctx.translate(0, this.startOff);

                gear.draw.color = "#333";
                gear.draw.text("MIRROR", -500, 0, 95, "font");
                var w = gear.ctx.measureText("MIRROR").width
                gear.draw.text("MIRROR", (gear.viewport.x - w) / 2, 200 + this.startOff2, 95, "font");

                gear.draw.color = "#222";
                gear.draw.text(language[lang]["play"], -500, 0, 65, "font");
                var w = gear.ctx.measureText(language[lang]["play"]).width
                gear.draw.text(language[lang]["play"], (gear.viewport.x - w) / 2, 450 + this.startOff2, 65, "font");
                // gear.draw.rect((gear.viewport.x - w) / 2 - 10, 450 - this.startOff - 55, w + 20, 80, true);

                gear.draw.color = lang == "en" ? "rgb(142, 219, 161)" : "#444";
                gear.draw.text("en", -500, 0, 35, "font");
                var w = gear.ctx.measureText("en").width
                gear.draw.text("en", (gear.viewport.x - w) / 2 - 40, 725 + this.startOff2, 35, "font");
                if (lang == "en") gear.draw.rect((gear.viewport.x - w) / 2 - 40, 735 + this.startOff2, w, 1);
                // gear.draw.rect((gear.viewport.x - w) / 2 - 50, 735 - this.startOff - 45, w + 20, 50, true);

                gear.draw.color = lang == "ru" ? "rgb(142, 219, 161)" : "#444";
                gear.draw.text("ru", -500, 0, 35, "font");
                var w = gear.ctx.measureText("ru").width
                gear.draw.text("ru", (gear.viewport.x - w) / 2 + 40, 725 + this.startOff2, 35, "font");
                if (lang == "ru") gear.draw.rect((gear.viewport.x - w) / 2 + 40, 735 + this.startOff2, w, 1);
                // gear.draw.rect((gear.viewport.x - w) / 2 + 30, 735 - this.startOff - 45, w + 20, 50, true);



                var h = false,
                    v = false;
                for (var i = 1; i < this.levels.length; i++) {
                    var l = this.levels[i],
                            pl = this.levels[i - 1];
                    if (i % 3 == 0) {
                        h = !h;
                        v = true;
                    } else {
                        v = false;
                    }
                    if (l.opened && pl.opened) {
                        gear.draw.color = "#c2c4c6";
                        if (!h) {
                            if (!v) {
                                gear.draw.rect(pl.x, l.y, Math.abs(pl.x - l.x), 3);
                            } else {
                                gear.draw.rect(pl.x, l.y, 3, Math.abs(pl.y - l.y));
                            }
                        }
                        else {
                            if (!v) {
                                gear.draw.rect(pl.x - Math.abs(pl.x - l.x), l.y, Math.abs(pl.x - l.x), 3);
                            } else {
                                gear.draw.rect(pl.x, l.y, 3, Math.abs(pl.y - l.y));
                            }
                        }
                    }
                }

                for (var i = 0; i < this.levels.length; i++) {
                    var l = this.levels[i];
                    gear.draw.color = !l.opened ? "#808fa3" : "#c2c4c6"; //rgb(36, 47, 63)
                    gear.draw.circle(l.x, l.y, l.r);
                    gear.draw.color = "#f7f7f7";
                    gear.draw.circle(l.x, l.y, l.r - 2);

                    if (!l.opened)
                        gear.ctx.drawImage(gear.images["locked"], l.x - 14, l.y - 14, 28, 28);
                    else
                        gear.ctx.drawImage(gear.images["opened"], l.x - 14, l.y - 14, 28, 28);
                }
                //gear.viewport.y - 55
                gear.ctx.drawImage(gear.images['down'], 220, this.levels[0].y + 65, 40, 40);

                gear.ctx.restore();
            }

        };

        var Test = {

            tutorial: false,

            tries: 0,

            startGame: false,
            alpha: 1,
            lTimer: 0,
            win: false,
            circle: null,
            player: null,
            move: false,
            fail: false,
            start: false,
            levelsSave: null,
            levelNumber: 0,
            repeat: false,
            timer: 0,
            timerStart: 0,
            timerNumber: 0,
            imgTimer: 0,
            imgPressed: false,
            cGray: { r: 247, g: 247, b: 247 },
            cRed: { r: 216, g: 140, b: 140 }, //rgb(229, 128, 114) rgb(216, 140, 140)
            cGreen: { r: 142, g: 219, b: 161 },//rgb(142, 189, 154) rgb(142, 219, 161)
            cColor: { r: 247, g: 247, b: 247 },
            cReverse: false,

            preload: function() {
                gear.load.image("menu", "res/img/menu2.png");
                gear.load.image("hand_pressed", "res/img/hand2.png");
                gear.load.image("hand", "res/img/hand2_pressed.png");
                gear.load.image("hand_move1", "res/img/hand_move1.png");
                gear.load.image("hand_move2", "res/img/hand_move2.png");
                gear.load.image("finger_up", "res/img/hand2.png");
                gear.load.image("finger_down", "res/img/hand2_pressed.png");
                gear.load.image("win", "res/img/win.png");
                gear.load.image("fail", "res/img/fail.png");
                gear.load.audio("swipe", "res/audio/swipe.mp3");
                gear.load.audio("win_back", "res/audio/win_back.mp3");
                gear.load.audio("fail_back", "res/audio/fail4.mp3");
                this.entity = function(x, y, r) {
                    this.x = x;
                    this.y = y;
                    this.cx = x;
                    this.cy = y;
                    this.offX = 0;
                    this.offY = 0;
                    this.t = 0;
                    this.r = r;
                    this.render = function() {
                        gear.draw.color = "rgb(36, 47, 63)";
                        gear.draw.circle(this.x, this.y, this.r);
                        gear.draw.color = "#f7f7f7";
                        gear.draw.circle(this.x, this.y, this.r - 1);
                    }
                };
            },

            init: function(data) {
                this.levelNumber = data.levelNumber || 0;
                this.reset();
                var saves = window.localStorage.getItem("mirror");
                if (!saves) {
                    this.levels[0].done = true;
                    window.localStorage.setItem("mirror", JSON.stringify({ levels: { 0: { done: true, tries: 0, fails: 0 } }, lang: "en" }));
                    return;
                }

                this.levelsSave = JSON.parse(saves).levels;

                if (!this.levelsSave[this.levelNumber + 1]) {
                    this.levelsSave[this.levelNumber + 1] = { done: false, tries: 0, fails: 0 };
                }

                console.log(this.levelsSave);

                if (levels[this.levelNumber]) {
                    if (levels[this.levelNumber].sx) {
                        this.circle.cx = levels[this.levelNumber].sx;
                        this.circle.x = levels[this.levelNumber].sx;
                        this.player.cx = levels[this.levelNumber].sx;
                        this.player.x = levels[this.levelNumber].sx;
                    }

                    levels[this.levelNumber].stages = 0;
                }

                if (this.levelNumber == 0) {
                    this.tutorial = true;
                }
            },

            checkFail: function(cx, px, d) {
                return Math.abs(cx - px) > d;
            },

            moveCircle: function() {
                var c = this.circle;
                c.t++;
                if (levels[this.levelNumber]) {
                    levels[this.levelNumber].update(c, this.timer++);
                }
            },

            reset: function() {
                this.startGame = false;
                this.alpha = 1;
                this.lTimer = 0;
                this.win = false;
                this.circle = new this.entity(240, 200, 30);
                this.player = new this.entity(240, 550, 30);
                this.tutplayer = new this.entity(240, 550, 30);
                this.move = false;
                this.fail = false;
                this.start = false;
                this.repeat = false;
                this.timer = 0;
                this.timerStart = 0;
                this.timerNumber = 0;
                this.imgTimer = 0;
                this.imgPressed = false;
                this.cColor = { r: 247, g: 247, b: 247 };
                this.cReverse = false;

                //tutorial
                this.tutorial = false;
                this.talpha = 0;
                this.ttimer = 0;
                this.tstages = 0;
                this.tchange = false;

                if (levels[this.levelNumber]) {
                    if (levels[this.levelNumber].sx) {
                        this.circle.cx = levels[this.levelNumber].sx;
                        this.circle.x = levels[this.levelNumber].sx;
                        this.player.cx = levels[this.levelNumber].sx;
                        this.player.x = levels[this.levelNumber].sx;
                    }

                    levels[this.levelNumber].stages = 0;

                }
            },

            cTransition: function(c1, c2, easing) {
                var vr = (c2.r - c1.r) * easing,
                        vg = (c2.g - c1.g) * easing,
                        vb = (c2.b - c1.b) * easing;

                c1.r += vr;
                c1.g += vg;
                c1.b += vb;

                return "rgb(" + Math.round(c1.r) + "," + Math.round(c1.g) + "," + Math.round(c1.b) + ")";
            },

            cDist: function(c1, c2) {
                return {
                    r: Math.abs(c1.r - c2.r),
                    g: Math.abs(c1.g - c2.g),
                    b: Math.abs(c1.b - c2.b)
                };
            },
            prevPressed: false,
            constX: null,
            update: function() {
                if (gear.input.isPressed && !this.prevPressed) {
                    gear.audios['click'].currentTime = 0;
                    gear.audios['click'].play();
                    this.constX = gear.input.x;
                    levels[this.levelNumber].stages = 0;
                }

                if (!gear.input.isPressed && !this.prevPressed) {
                	this.constX = null;
                }

                if (gear.input.y < 100 && gear.input.isPressed) {
                    if (containRect(gear.input, {x: gear.viewport.x - 60, y: 10, width: 40, height: 40 })) {
                        gear.input.isPressed = false;
                        gear.state.start("menu");
                    }
                }
                if (this.tutorial) {
                    this.ututorial();
                    this.prevPressed = gear.input.isPressed;
                    return;
                }

                if (!this.startGame || this.win) {
                	this.prevPressed = gear.input.isPressed;
                    return;
                }
                    //gear.viewport.x - 60, 10, 40, 40

                if (!this.start) {
                	if (Math.abs(gear.input.x - this.constX) > 5 && this.constX != null)
                        this.start = true;
                    if (!gear.input.isPressed)
                        this.moveCircle(this.levelNumber);
                    else {
                        this.circle.t = 0;
                        this.imgTimer = 0;
                        this.imgPressed = false;
                        var dx = this.circle.cx - this.circle.x,
                            vx = dx * 0.05;

                        this.circle.x += vx;
                    }
                } else {
                    if (this.fail)
                        return;

                    this.moveCircle(this.levelNumber);
                    if (gear.input.isPressed) {
                            if (!this.move) {
                                this.offX = this.player.x - gear.input.x;
                                this.move = true;
                            } else {
                                this.player.x = gear.input.x + this.offX;
                                this.player.x = Math.max(Math.min(this.player.x, 380), 100);
                            }
                    } else {
                        this.move = false;
                        var dx = this.player.cx - this.player.x,
                            vx = dx * 0.05;

                        this.player.x += vx;
                    }

                    if (this.checkFail(this.circle.x, this.player.x, 17) && !this.fail) {
                        this.fail = true;
                        gear.audios['swipe'].play();
                        this.levelsSave[this.levelNumber].tries++;
                        this.levelsSave[this.levelNumber].fails++;
                        window.localStorage.setItem("mirror", JSON.stringify({ levels: this.levelsSave, lang: lang }));
                    } else {
                        if (!levels[this.levelNumber])
                            return;

                        if (levels[this.levelNumber].finished && !this.win) {
                            this.levelsSave[this.levelNumber + 1].done = true;
                            this.levelsSave[this.levelNumber].tries++;
                            this.win = true;
                            gear.audios['swipe'].play();
                            // if (this.levelNumber == 4)
                            //  return;
                            window.localStorage.setItem("mirror", JSON.stringify({ levels: this.levelsSave, lang: lang }));
                        }
                    }

                }
                
                this.prevPressed = gear.input.isPressed;
            },

            render: function() {
                gear.draw.clear("rgb(247, 247, 247)");

                if (this.tutorial) {
                    this.rtutorial();
                    return;
                }

                /*gear.draw.color = "rgba(36, 47, 63, 0.7)";
                gear.draw.text(this.levelNumber, x, -40, 23);
                var x = (gear.viewport.x -
                                 gear.ctx.measureText(this.levelNumber + 1).width) / 2;
                gear.draw.text(this.levelNumber + 1, x, 40, 23);*/

                gear.ctx.drawImage(gear.images['menu'], gear.viewport.x - 50, 20, 25, 25);

                if (!this.start) {
                    gear.draw.color = "#67696d";
                    if (gear.input.isPressed && this.startGame && gear.input.y > 100) {
                        // this.timerStart++;
                        // if (this.timerStart % 40 == 0 && this.timerStart != 0) {
                        //     this.timerNumber++;
                        //     if (this.timerNumber == 2) {
                        //     	levels[this.levelNumber].stages = 0;
                        //     }
                        // }
                        // if (gear.input.x != this.prevPressed.x)
                            // this.start = true;
                        gear.draw.text(language[lang]['start'][0], x, -370, 70, "font");
                        var x = (gear.viewport.x -
                                         gear.ctx.measureText(language[lang]['start'][0]).width) / 2;
                        if (this.timerNumber != 2)
                            gear.draw.text(language[lang]['start'][0], x, 370, 70, "font");
                    } else {
                        this.timerNumber = 0;
                        this.timerStart = 0;
                        gear.draw.text(language[lang]["rule"], x, -370, 40, "font");
                        var x = (gear.viewport.x -
                                         gear.ctx.measureText(language[lang]["rule"]).width) / 2;
                        gear.draw.text(language[lang]["rule"], x, 370, 40, "font");

                        this.imgTimer++;

                        if (this.imgTimer % 40 == 0 && this.startGame) {
                            this.imgPressed = !this.imgPressed;
                            this.imgTimer = 0;
                        }

                        if (this.imgPressed)
                            gear.ctx.drawImage(gear.images["hand_move1"],
                                                             (gear.viewport.x - 60) / 2 + 10, 610, 60, 60);
                        else
                            gear.ctx.drawImage(gear.images["hand_move2"],
                                                         (gear.viewport.x - 70) / 2 + 10, 610, 60, 60);

                    }

                }

                gear.draw.lineWidth = 2;
                // example
                gear.draw.color = "#808fa3";
                gear.draw.rect(100, 200, 280, 2);
                this.circle.render();
                /*gear.draw.color = "rgb(140, 50, 180)";
                gear.draw.rect(this.player.x, 500, this.circle.x - this.player.x, 8);
                gear.draw.color = "rgb(180, 50, 140)";
                gear.draw.rect(this.player.x, 500, 20, 8);*/
                // player
                gear.draw.color = "#808fa3";
                gear.draw.rect(100, 550, 280, 2);
                this.player.render();

                if (this.fail) {
                    var color = null;

                    if (!this.cReverse) {
                        color = this.cTransition(this.cColor, this.cRed, 0.1);
                        var d = this.cDist(this.cColor, this.cRed);
                        if (d.r < 5 && d.g < 5 && d.b < 5) {
                            this.cReverse = true;
                            gear.audios['fail_back'].play();
                        }
                    }
                    else {
                        color = this.cTransition(this.cColor, this.cGray, 0.09);
                        var d = this.cDist(this.cColor, this.cGray);
                        if (d.r < 3 && d.g < 3 && d.b < 3) {
                            this.reset();
                        }
                    }
                    gear.draw.clear(color);
                    gear.ctx.drawImage(gear.images['fail'],
                                                        (gear.viewport.x - 150) / 2,
                                                        (gear.viewport.y - 150) / 2,
                                                        150, 150);
                } else if (this.win) {
                    var color = null,
                        tColor = null;

                    if (!this.cReverse) {
                        color = this.cTransition(this.cColor, this.cGreen, 0.1);
                        var d = this.cDist(this.cColor, this.cGreen);
                        if (d.r < 1 && d.g < 1 && d.b < 1) {
                            this.cReverse = true;
                            gear.audios['win_back'].play();
                        }
                    }
                    else {
                        color = this.cTransition(this.cColor, this.cGray, 0.09);
                        var d = this.cDist(this.cColor, this.cGray);
                        if (d.r < 5 && d.g < 5 && d.b < 5) {
                            // if (this.levelNumber == 4)
                            //  gear.state.start("menu");
                            // else
                            gear.state.start("test", { levelNumber: this.levelNumber + 1, levelsSave: this.levelsSave });
                        }
                    }
                    gear.draw.clear(color);
                    gear.ctx.drawImage(gear.images['win'],
                                                        (gear.viewport.x - 200) / 2,
                                                        (gear.viewport.y - 200) / 2,
                                                        200, 200);
                }

                if (!this.startGame) {
                    var va = (0 - this.alpha) * 0.035;
                    this.alpha += va;
                    gear.draw.clear("rgba(247, 247, 247, " + this.alpha + ")");
                    gear.draw.text(language[lang]["level"] + " " + (this.levelNumber + 1), 30, -30, 34, "font");

                    // gear.draw.color = "#242f3f";
                    // var x = gear.ctx.measureText("Level " + (this.levelNumber + 1)).width;
                    // gear.draw.rect((gear.viewport.x - x) / 2 - 10, 5 + Math.sin(this.alpha) * 70, 20 + x, 50);

                    if (Math.abs(this.alpha) < 2) {
                        this.lTimer += 0.04;
                        gear.draw.color = "#67696d";
                        var x = gear.ctx.measureText(language[lang]["level"] + " " + (this.levelNumber)).width;
                        var y = Math.min(Math.sin(this.lTimer) * 70, 45);
                        gear.draw.text(language[lang]["level"] + " " + (this.levelNumber), (gear.viewport.x - x) / 2, y, 34, "font");
                        gear.draw.rect((gear.viewport.x - x) / 2 - 10, 10 + y, x + 20, 1);

                        if (this.lTimer > 4)
                            this.startGame = true;
                    }
                }
                // gear.draw.color = "red";
                // gear.draw.rect(gear.viewport.x - 60, 10, 40, 40);

            },

            ututorial: function() {
                switch(this.tstages) {
                    case 0:
                        if (Math.abs(1 - this.talpha) < 0.1) {
                            if (levels[this.levelNumber].times > 1) {
                                this.tchange = true;
                                levels[this.levelNumber].times = 0;
                            }

                            this.moveCircle(this.levelNumber);
                        }
                    break;
                    case 1:
                        if (Math.abs(1 - this.talpha) < 0.1 && !this.win) {
                            this.ttimer++;
                            if (this.ttimer > 70) {
                                if (levels[this.levelNumber].times < 1) {
                                    this.moveCircle(this.levelNumber);
                                }
                                var vx = (this.circle.x - this.tutplayer.x) * 0.1;
                                this.tutplayer.x += vx;
                            }
                        }
                        if (!this.checkFail(this.circle.x, this.tutplayer.x, 20)) {
                            if (!levels[this.levelNumber])
                                return;

                            if (levels[this.levelNumber].finished && !this.win) {
                                this.levelsSave[this.levelNumber + 1].done = true;
                                this.levelsSave[this.levelNumber].tries++;
                                this.win = true;
                                gear.audios['swipe'].play();
                                if (this.levelNumber == 4)
                                    return;
                                window.localStorage.setItem("mirror", JSON.stringify({ levels: this.levelsSave, lang: lang }));
                            }
                        }
                    break;
                    case 2:

                    break;
                }
            },
            talpha: 0,
            ttimer: 0,
            tstages: 0,
            tchange: false,
            rtutorial: function() {
                gear.ctx.drawImage(gear.images['menu'], gear.viewport.x - 50, 20, 25, 25);

                gear.draw.lineWidth = 2;
                // example
                gear.draw.color = "#808fa3";
                gear.draw.rect(100, 200, 280, 2);
                this.circle.render();

                // player
                gear.draw.color = "#808fa3";
                gear.draw.rect(100, 550, 280, 2);
                this.tutplayer.render();

                if (!this.startGame) {
                    var va = (0 - this.alpha) * 0.035;
                    this.alpha += va;
                    gear.draw.clear("rgba(247, 247, 247, " + this.alpha + ")");
                    gear.draw.text(language[lang]["tutorial"], 30, -30, 34, "font");

                    if (Math.abs(this.alpha) < 2) {
                        this.lTimer += 0.04;
                        gear.draw.color = "#67696d";
                        var x = gear.ctx.measureText(language[lang]["tutorial"]).width;
                        var y = Math.min(Math.sin(this.lTimer) * 70, 45);
                        gear.draw.text(language[lang]["tutorial"], (gear.viewport.x - x) / 2, y, 34, "font");
                        gear.draw.rect((gear.viewport.x - x) / 2 - 10, 10 + y, x + 20, 1);

                        if (this.lTimer > 4)
                            this.startGame = true;
                    }
                } else {

                    switch(this.tstages) {
                        case 0:
                            if (!this.tchange) {
                                var va = (1 - this.talpha) * 0.03;
                                this.talpha += va;
                                if (Math.abs(1 - this.talpha) < 0.05) {
                                    // this.tchange = true;
                                }   
                            } else {
                                var va = (-.2 - this.talpha) * 0.03;
                                this.talpha += va;
                                if (Math.abs(-.2 - this.talpha) < 0.09) {
                                    this.talpha = 0;
                                    this.tchange = false;
                                    this.tstages++;
                                }   
                            }
                            gear.draw.color = "rgba(255, 255, 255, " + this.talpha + ")";
                            gear.draw.rect(0, 0, gear.viewport.x, 150);
                            gear.draw.rect(0, 250, gear.viewport.x, gear.viewport.y);
                        break;
                        case 1:
                            if (!this.tchange) {
                                var va = (1 - this.talpha) * 0.03;
                                this.talpha += va;
                                if (Math.abs(1 - this.talpha) < 0.05) {
                                    // this.tchange = true;
                                }   
                            } else {
                                var va = (-.2 - this.talpha) * 0.03;
                                this.talpha += va;
                                if (Math.abs(-.2 - this.talpha) < 0.01) {
                                    this.tstages++;
                                }   
                            }
                            gear.draw.color = "rgba(255, 255, 255, " + this.talpha + ")";
                            gear.draw.rect(0, 0, gear.viewport.x, 150);
                            gear.draw.rect(0, 250, gear.viewport.x, 250);
                            gear.draw.rect(0, 600, gear.viewport.x, 300);

                            if (this.ttimer < 50 && this.ttimer > 10) {
                                gear.ctx.drawImage(gear.images["finger_down"], this.tutplayer.x - 35, 650, 100, 100);
                            }
                            else if (this.ttimer > 50) {
                                gear.ctx.drawImage(gear.images["finger_up"], this.tutplayer.x - 25, 650, 70, 70);
                            }
                        break;
                        case 2:

                        break;
                    }

                    gear.draw.color = "rgba(51, 51, 51, " + (.1 + this.talpha) + ")";
                    gear.draw.text(language[lang]['rules'][this.tstages], 0, -370, 50, "font");
                    var x = (gear.viewport.x -
                                     gear.ctx.measureText(language[lang]['rules'][this.tstages]).width) / 2;
                    gear.draw.text(language[lang]['rules'][this.tstages], x, 390, 50, "font");

                    if (this.win) {
                        var color = null,
                            tColor = null;

                        if (!this.cReverse) {
                            color = this.cTransition(this.cColor, this.cGreen, 0.1);
                            var d = this.cDist(this.cColor, this.cGreen);
                            if (d.r < 1 && d.g < 1 && d.b < 1) {
                                this.cReverse = true;
                                gear.audios['win_back'].play();
                            }
                        }
                        else {
                            color = this.cTransition(this.cColor, this.cGray, 0.09);
                            var d = this.cDist(this.cColor, this.cGray);
                            if (d.r < 5 && d.g < 5 && d.b < 5) {
                                if (this.levelNumber == 4)
                                    gear.state.start("menu");
                                else
                                    gear.state.start("test", { levelNumber: this.levelNumber + 1, levelsSave: this.levelsSave });
                            }
                        }
                        gear.draw.clear(color);
                        gear.ctx.drawImage(gear.images['win'],
                                                            (gear.viewport.x - 200) / 2,
                                                            (gear.viewport.y - 200) / 2,
                                                            200, 200);
                    }
                }

            }
        }

        var Info = {
            update: function() {
                if (gear.input.isPressed)
                    gear.state.start("menu");
            },
            render: function() {
                    gear.draw.clear("rgb(247, 247, 247)");

                    gear.draw.color = "#333";
                    gear.draw.text("that's all for now", 110, 250, 35, "font");
                    gear.draw.text("this is short demo", 100, 300, 35, "font");
                    gear.draw.text("please tell me your opinion", 55, 350, 30, "font");
                    gear.draw.text("tap to go to menu", 130, 650, 25, "font");
            }
        };

        gear.state.create("menu", Menu);
        gear.state.create("test", Test);
        gear.state.create("info", Info);
        gear.state.start("menu");

    </script>
</body>
</html>
